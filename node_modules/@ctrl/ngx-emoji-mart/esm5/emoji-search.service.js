/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { categories, EmojiService, } from '@ctrl/ngx-emoji-mart/ngx-emoji';
import { intersect } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "@ctrl/ngx-emoji-mart/ngx-emoji";
var EmojiSearch = /** @class */ (function () {
    function EmojiSearch(emojiService) {
        var e_1, _a;
        var _this = this;
        this.emojiService = emojiService;
        this.originalPool = {};
        this.index = {};
        this.emojisList = {};
        this.emoticonsList = {};
        this.emojiSearch = {};
        var _loop_1 = function (emojiData) {
            var shortNames = emojiData.shortNames, emoticons = emojiData.emoticons;
            /** @type {?} */
            var id = shortNames[0];
            emoticons.forEach((/**
             * @param {?} emoticon
             * @return {?}
             */
            function (emoticon) {
                if (_this.emoticonsList[emoticon]) {
                    return;
                }
                _this.emoticonsList[emoticon] = id;
            }));
            this_1.emojisList[id] = this_1.emojiService.getSanitizedData(id);
            this_1.originalPool[id] = emojiData;
        };
        var this_1 = this;
        try {
            for (var _b = tslib_1.__values(this.emojiService.emojis), _c = _b.next(); !_c.done; _c = _b.next()) {
                var emojiData = _c.value;
                _loop_1(emojiData);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
    }
    /**
     * @param {?} custom
     * @param {?} pool
     * @return {?}
     */
    EmojiSearch.prototype.addCustomToPool = /**
     * @param {?} custom
     * @param {?} pool
     * @return {?}
     */
    function (custom, pool) {
        var _this = this;
        custom.forEach((/**
         * @param {?} emoji
         * @return {?}
         */
        function (emoji) {
            /** @type {?} */
            var emojiId = emoji.id || emoji.shortNames[0];
            if (emojiId && !pool[emojiId]) {
                pool[emojiId] = _this.emojiService.getData(emoji);
                _this.emojisList[emojiId] = _this.emojiService.getSanitizedData(emoji);
            }
        }));
    };
    /**
     * @param {?} value
     * @param {?=} emojisToShowFilter
     * @param {?=} maxResults
     * @param {?=} include
     * @param {?=} exclude
     * @param {?=} custom
     * @return {?}
     */
    EmojiSearch.prototype.search = /**
     * @param {?} value
     * @param {?=} emojisToShowFilter
     * @param {?=} maxResults
     * @param {?=} include
     * @param {?=} exclude
     * @param {?=} custom
     * @return {?}
     */
    function (value, emojisToShowFilter, maxResults, include, exclude, custom) {
        var _this = this;
        if (maxResults === void 0) { maxResults = 75; }
        if (include === void 0) { include = []; }
        if (exclude === void 0) { exclude = []; }
        if (custom === void 0) { custom = []; }
        this.addCustomToPool(custom, this.originalPool);
        /** @type {?} */
        var results;
        /** @type {?} */
        var pool = this.originalPool;
        if (value.length) {
            if (value === '-' || value === '-1') {
                return [this.emojisList['-1']];
            }
            /** @type {?} */
            var values = value.toLowerCase().split(/[\s|,|\-|_]+/);
            /** @type {?} */
            var allResults = [];
            if (values.length > 2) {
                values = [values[0], values[1]];
            }
            if (include.length || exclude.length) {
                pool = {};
                categories.forEach((/**
                 * @param {?} category
                 * @return {?}
                 */
                function (category) {
                    /** @type {?} */
                    var isIncluded = include && include.length
                        ? include.indexOf(category.id) > -1
                        : true;
                    /** @type {?} */
                    var isExcluded = exclude && exclude.length
                        ? exclude.indexOf(category.id) > -1
                        : false;
                    if (!isIncluded || isExcluded) {
                        return;
                    }
                    (/** @type {?} */ (category.emojis)).forEach((/**
                     * @param {?} emojiId
                     * @return {?}
                     */
                    function (emojiId) { return (pool[emojiId] = _this.emojiService.names[emojiId]); }));
                }));
                if (custom.length) {
                    /** @type {?} */
                    var customIsIncluded = include && include.length ? include.indexOf('custom') > -1 : true;
                    /** @type {?} */
                    var customIsExcluded = exclude && exclude.length ? exclude.indexOf('custom') > -1 : false;
                    if (customIsIncluded && !customIsExcluded) {
                        this.addCustomToPool(custom, pool);
                    }
                }
            }
            allResults = values
                .map((/**
             * @param {?} v
             * @return {?}
             */
            function (v) {
                /** @type {?} */
                var aPool = pool;
                /** @type {?} */
                var aIndex = _this.index;
                /** @type {?} */
                var length = 0;
                var _loop_2 = function (charIndex) {
                    var e_2, _a;
                    /** @type {?} */
                    var char = v[charIndex];
                    length++;
                    if (!aIndex[char]) {
                        aIndex[char] = {};
                    }
                    aIndex = aIndex[char];
                    if (!aIndex.results) {
                        /** @type {?} */
                        var scores_1 = {};
                        aIndex.results = [];
                        aIndex.pool = {};
                        try {
                            for (var _b = tslib_1.__values(Object.keys(aPool)), _c = _b.next(); !_c.done; _c = _b.next()) {
                                var id = _c.value;
                                /** @type {?} */
                                var emoji = aPool[id];
                                if (!_this.emojiSearch[id]) {
                                    _this.emojiSearch[id] = _this.buildSearch(emoji.short_names, emoji.name, emoji.keywords, emoji.emoticons);
                                }
                                /** @type {?} */
                                var query = _this.emojiSearch[id];
                                /** @type {?} */
                                var sub = v.substr(0, length);
                                /** @type {?} */
                                var subIndex = query.indexOf(sub);
                                if (subIndex !== -1) {
                                    /** @type {?} */
                                    var score = subIndex + 1;
                                    if (sub === id) {
                                        score = 0;
                                    }
                                    aIndex.results.push(_this.emojisList[id]);
                                    aIndex.pool[id] = emoji;
                                    scores_1[id] = score;
                                }
                            }
                        }
                        catch (e_2_1) { e_2 = { error: e_2_1 }; }
                        finally {
                            try {
                                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                            }
                            finally { if (e_2) throw e_2.error; }
                        }
                        aIndex.results.sort((/**
                         * @param {?} a
                         * @param {?} b
                         * @return {?}
                         */
                        function (a, b) {
                            /** @type {?} */
                            var aScore = scores_1[a.id];
                            /** @type {?} */
                            var bScore = scores_1[b.id];
                            return aScore - bScore;
                        }));
                    }
                    aPool = aIndex.pool;
                };
                for (var charIndex = 0; charIndex < v.length; charIndex++) {
                    _loop_2(charIndex);
                }
                return aIndex.results;
            }))
                .filter((/**
             * @param {?} a
             * @return {?}
             */
            function (a) { return a; }));
            if (allResults.length > 1) {
                results = intersect.apply(null, (/** @type {?} */ (allResults)));
            }
            else if (allResults.length) {
                results = allResults[0];
            }
            else {
                results = [];
            }
        }
        if (results) {
            if (emojisToShowFilter) {
                results = results.filter((/**
                 * @param {?} result
                 * @return {?}
                 */
                function (result) {
                    return emojisToShowFilter(_this.emojiService.names[result.id]);
                }));
            }
            if (results && results.length > maxResults) {
                results = results.slice(0, maxResults);
            }
        }
        return results || null;
    };
    /**
     * @param {?} short_names
     * @param {?} name
     * @param {?} keywords
     * @param {?} emoticons
     * @return {?}
     */
    EmojiSearch.prototype.buildSearch = /**
     * @param {?} short_names
     * @param {?} name
     * @param {?} keywords
     * @param {?} emoticons
     * @return {?}
     */
    function (short_names, name, keywords, emoticons) {
        /** @type {?} */
        var search = [];
        /** @type {?} */
        var addToSearch = (/**
         * @param {?} strings
         * @param {?} split
         * @return {?}
         */
        function (strings, split) {
            if (!strings) {
                return;
            }
            (Array.isArray(strings) ? strings : [strings]).forEach((/**
             * @param {?} string
             * @return {?}
             */
            function (string) {
                (split ? string.split(/[-|_|\s]+/) : [string]).forEach((/**
                 * @param {?} s
                 * @return {?}
                 */
                function (s) {
                    s = s.toLowerCase();
                    if (!search.includes(s)) {
                        search.push(s);
                    }
                }));
            }));
        });
        addToSearch(short_names, true);
        addToSearch(name, true);
        addToSearch(keywords, false);
        addToSearch(emoticons, false);
        return search.join(',');
    };
    EmojiSearch.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] }
    ];
    /** @nocollapse */
    EmojiSearch.ctorParameters = function () { return [
        { type: EmojiService }
    ]; };
    /** @nocollapse */ EmojiSearch.ngInjectableDef = i0.defineInjectable({ factory: function EmojiSearch_Factory() { return new EmojiSearch(i0.inject(i1.EmojiService)); }, token: EmojiSearch, providedIn: "root" });
    return EmojiSearch;
}());
export { EmojiSearch };
if (false) {
    /** @type {?} */
    EmojiSearch.prototype.originalPool;
    /** @type {?} */
    EmojiSearch.prototype.index;
    /** @type {?} */
    EmojiSearch.prototype.emojisList;
    /** @type {?} */
    EmojiSearch.prototype.emoticonsList;
    /** @type {?} */
    EmojiSearch.prototype.emojiSearch;
    /**
     * @type {?}
     * @private
     */
    EmojiSearch.prototype.emojiService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vamktc2VhcmNoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY3RybC9uZ3gtZW1vamktbWFydC8iLCJzb3VyY2VzIjpbImVtb2ppLXNlYXJjaC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQ0wsVUFBVSxFQUVWLFlBQVksR0FDYixNQUFNLGdDQUFnQyxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxTQUFTLENBQUM7OztBQUVwQztJQVlFLHFCQUFvQixZQUEwQjs7UUFBOUMsaUJBZ0JDO1FBaEJtQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQVY5QyxpQkFBWSxHQUFRLEVBQUUsQ0FBQztRQUN2QixVQUFLLEdBSUQsRUFBRSxDQUFDO1FBQ1AsZUFBVSxHQUFRLEVBQUUsQ0FBQztRQUNyQixrQkFBYSxHQUE4QixFQUFFLENBQUM7UUFDOUMsZ0JBQVcsR0FBOEIsRUFBRSxDQUFDO2dDQUcvQixTQUFTO1lBQ1YsSUFBQSxpQ0FBVSxFQUFFLCtCQUFTOztnQkFDdkIsRUFBRSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFFeEIsU0FBUyxDQUFDLE9BQU87Ozs7WUFBQyxVQUFBLFFBQVE7Z0JBQ3hCLElBQUksS0FBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRTtvQkFDaEMsT0FBTztpQkFDUjtnQkFFRCxLQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNwQyxDQUFDLEVBQUMsQ0FBQztZQUVILE9BQUssVUFBVSxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQUssWUFBWSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzdELE9BQUssWUFBWSxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQzs7OztZQWJwQyxLQUF3QixJQUFBLEtBQUEsaUJBQUEsSUFB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O2dCQXJORixVQUFVLFNBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzs7O2dCQUpoQyxZQUFZOzs7c0JBTGQ7Q0ErTkMsQUF0TkQsSUFzTkM7U0FyTlksV0FBVzs7O0lBQ3RCLG1DQUF1Qjs7SUFDdkIsNEJBSU87O0lBQ1AsaUNBQXFCOztJQUNyQixvQ0FBOEM7O0lBQzlDLGtDQUE0Qzs7Ozs7SUFFaEMsbUNBQWtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQge1xuICBjYXRlZ29yaWVzLFxuICBFbW9qaURhdGEsXG4gIEVtb2ppU2VydmljZSxcbn0gZnJvbSAnQGN0cmwvbmd4LWVtb2ppLW1hcnQvbmd4LWVtb2ppJztcbmltcG9ydCB7IGludGVyc2VjdCB9IGZyb20gJy4vdXRpbHMnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIEVtb2ppU2VhcmNoIHtcbiAgb3JpZ2luYWxQb29sOiBhbnkgPSB7fTtcbiAgaW5kZXg6IHtcbiAgICByZXN1bHRzPzogRW1vamlEYXRhW107XG4gICAgcG9vbD86IHsgW2tleTogc3RyaW5nXTogRW1vamlEYXRhIH07XG4gICAgW2tleTogc3RyaW5nXTogYW55O1xuICB9ID0ge307XG4gIGVtb2ppc0xpc3Q6IGFueSA9IHt9O1xuICBlbW90aWNvbnNMaXN0OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG4gIGVtb2ppU2VhcmNoOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbW9qaVNlcnZpY2U6IEVtb2ppU2VydmljZSkge1xuICAgIGZvciAoY29uc3QgZW1vamlEYXRhIG9mIHRoaXMuZW1vamlTZXJ2aWNlLmVtb2ppcykge1xuICAgICAgY29uc3QgeyBzaG9ydE5hbWVzLCBlbW90aWNvbnMgfSA9IGVtb2ppRGF0YTtcbiAgICAgIGNvbnN0IGlkID0gc2hvcnROYW1lc1swXTtcblxuICAgICAgZW1vdGljb25zLmZvckVhY2goZW1vdGljb24gPT4ge1xuICAgICAgICBpZiAodGhpcy5lbW90aWNvbnNMaXN0W2Vtb3RpY29uXSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZW1vdGljb25zTGlzdFtlbW90aWNvbl0gPSBpZDtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmVtb2ppc0xpc3RbaWRdID0gdGhpcy5lbW9qaVNlcnZpY2UuZ2V0U2FuaXRpemVkRGF0YShpZCk7XG4gICAgICB0aGlzLm9yaWdpbmFsUG9vbFtpZF0gPSBlbW9qaURhdGE7XG4gICAgfVxuICB9XG5cbiAgYWRkQ3VzdG9tVG9Qb29sKGN1c3RvbTogYW55LCBwb29sOiBhbnkpIHtcbiAgICBjdXN0b20uZm9yRWFjaCgoZW1vamk6IGFueSkgPT4ge1xuICAgICAgY29uc3QgZW1vamlJZCA9IGVtb2ppLmlkIHx8IGVtb2ppLnNob3J0TmFtZXNbMF07XG5cbiAgICAgIGlmIChlbW9qaUlkICYmICFwb29sW2Vtb2ppSWRdKSB7XG4gICAgICAgIHBvb2xbZW1vamlJZF0gPSB0aGlzLmVtb2ppU2VydmljZS5nZXREYXRhKGVtb2ppKTtcbiAgICAgICAgdGhpcy5lbW9qaXNMaXN0W2Vtb2ppSWRdID0gdGhpcy5lbW9qaVNlcnZpY2UuZ2V0U2FuaXRpemVkRGF0YShlbW9qaSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzZWFyY2goXG4gICAgdmFsdWU6IHN0cmluZyxcbiAgICBlbW9qaXNUb1Nob3dGaWx0ZXI/OiAoeDogYW55KSA9PiBib29sZWFuLFxuICAgIG1heFJlc3VsdHMgPSA3NSxcbiAgICBpbmNsdWRlOiBhbnlbXSA9IFtdLFxuICAgIGV4Y2x1ZGU6IGFueVtdID0gW10sXG4gICAgY3VzdG9tOiBhbnlbXSA9IFtdLFxuICApOiBFbW9qaURhdGFbXSB8IG51bGwge1xuICAgIHRoaXMuYWRkQ3VzdG9tVG9Qb29sKGN1c3RvbSwgdGhpcy5vcmlnaW5hbFBvb2wpO1xuXG4gICAgbGV0IHJlc3VsdHM6IEVtb2ppRGF0YVtdIHwgdW5kZWZpbmVkO1xuICAgIGxldCBwb29sID0gdGhpcy5vcmlnaW5hbFBvb2w7XG5cbiAgICBpZiAodmFsdWUubGVuZ3RoKSB7XG4gICAgICBpZiAodmFsdWUgPT09ICctJyB8fCB2YWx1ZSA9PT0gJy0xJykge1xuICAgICAgICByZXR1cm4gW3RoaXMuZW1vamlzTGlzdFsnLTEnXV07XG4gICAgICB9XG5cbiAgICAgIGxldCB2YWx1ZXMgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpLnNwbGl0KC9bXFxzfCx8XFwtfF9dKy8pO1xuICAgICAgbGV0IGFsbFJlc3VsdHMgPSBbXTtcblxuICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPiAyKSB7XG4gICAgICAgIHZhbHVlcyA9IFt2YWx1ZXNbMF0sIHZhbHVlc1sxXV07XG4gICAgICB9XG5cbiAgICAgIGlmIChpbmNsdWRlLmxlbmd0aCB8fCBleGNsdWRlLmxlbmd0aCkge1xuICAgICAgICBwb29sID0ge307XG5cbiAgICAgICAgY2F0ZWdvcmllcy5mb3JFYWNoKGNhdGVnb3J5ID0+IHtcbiAgICAgICAgICBjb25zdCBpc0luY2x1ZGVkID1cbiAgICAgICAgICAgIGluY2x1ZGUgJiYgaW5jbHVkZS5sZW5ndGhcbiAgICAgICAgICAgICAgPyBpbmNsdWRlLmluZGV4T2YoY2F0ZWdvcnkuaWQpID4gLTFcbiAgICAgICAgICAgICAgOiB0cnVlO1xuICAgICAgICAgIGNvbnN0IGlzRXhjbHVkZWQgPVxuICAgICAgICAgICAgZXhjbHVkZSAmJiBleGNsdWRlLmxlbmd0aFxuICAgICAgICAgICAgICA/IGV4Y2x1ZGUuaW5kZXhPZihjYXRlZ29yeS5pZCkgPiAtMVxuICAgICAgICAgICAgICA6IGZhbHNlO1xuICAgICAgICAgIGlmICghaXNJbmNsdWRlZCB8fCBpc0V4Y2x1ZGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY2F0ZWdvcnkuZW1vamlzIS5mb3JFYWNoKFxuICAgICAgICAgICAgZW1vamlJZCA9PiAocG9vbFtlbW9qaUlkXSA9IHRoaXMuZW1vamlTZXJ2aWNlLm5hbWVzW2Vtb2ppSWRdKSxcbiAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoY3VzdG9tLmxlbmd0aCkge1xuICAgICAgICAgIGNvbnN0IGN1c3RvbUlzSW5jbHVkZWQgPVxuICAgICAgICAgICAgaW5jbHVkZSAmJiBpbmNsdWRlLmxlbmd0aCA/IGluY2x1ZGUuaW5kZXhPZignY3VzdG9tJykgPiAtMSA6IHRydWU7XG4gICAgICAgICAgY29uc3QgY3VzdG9tSXNFeGNsdWRlZCA9XG4gICAgICAgICAgICBleGNsdWRlICYmIGV4Y2x1ZGUubGVuZ3RoID8gZXhjbHVkZS5pbmRleE9mKCdjdXN0b20nKSA+IC0xIDogZmFsc2U7XG4gICAgICAgICAgaWYgKGN1c3RvbUlzSW5jbHVkZWQgJiYgIWN1c3RvbUlzRXhjbHVkZWQpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkQ3VzdG9tVG9Qb29sKGN1c3RvbSwgcG9vbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGFsbFJlc3VsdHMgPSB2YWx1ZXNcbiAgICAgICAgLm1hcCh2ID0+IHtcbiAgICAgICAgICBsZXQgYVBvb2wgPSBwb29sO1xuICAgICAgICAgIGxldCBhSW5kZXggPSB0aGlzLmluZGV4O1xuICAgICAgICAgIGxldCBsZW5ndGggPSAwO1xuXG4gICAgICAgICAgZm9yIChsZXQgY2hhckluZGV4ID0gMDsgY2hhckluZGV4IDwgdi5sZW5ndGg7IGNoYXJJbmRleCsrKSB7XG4gICAgICAgICAgICBjb25zdCBjaGFyID0gdltjaGFySW5kZXhdO1xuICAgICAgICAgICAgbGVuZ3RoKys7XG4gICAgICAgICAgICBpZiAoIWFJbmRleFtjaGFyXSkge1xuICAgICAgICAgICAgICBhSW5kZXhbY2hhcl0gPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFJbmRleCA9IGFJbmRleFtjaGFyXTtcblxuICAgICAgICAgICAgaWYgKCFhSW5kZXgucmVzdWx0cykge1xuICAgICAgICAgICAgICBjb25zdCBzY29yZXM6IHsgW2tleTogc3RyaW5nXTogbnVtYmVyIH0gPSB7fTtcblxuICAgICAgICAgICAgICBhSW5kZXgucmVzdWx0cyA9IFtdO1xuICAgICAgICAgICAgICBhSW5kZXgucG9vbCA9IHt9O1xuXG4gICAgICAgICAgICAgIGZvciAoY29uc3QgaWQgb2YgT2JqZWN0LmtleXMoYVBvb2wpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW1vamkgPSBhUG9vbFtpZF07XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmVtb2ppU2VhcmNoW2lkXSkge1xuICAgICAgICAgICAgICAgICAgdGhpcy5lbW9qaVNlYXJjaFtpZF0gPSB0aGlzLmJ1aWxkU2VhcmNoKFxuICAgICAgICAgICAgICAgICAgICBlbW9qaS5zaG9ydF9uYW1lcyxcbiAgICAgICAgICAgICAgICAgICAgZW1vamkubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgZW1vamkua2V5d29yZHMsXG4gICAgICAgICAgICAgICAgICAgIGVtb2ppLmVtb3RpY29ucyxcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5lbW9qaVNlYXJjaFtpZF07XG4gICAgICAgICAgICAgICAgY29uc3Qgc3ViID0gdi5zdWJzdHIoMCwgbGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWJJbmRleCA9IHF1ZXJ5LmluZGV4T2Yoc3ViKTtcblxuICAgICAgICAgICAgICAgIGlmIChzdWJJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgIGxldCBzY29yZSA9IHN1YkluZGV4ICsgMTtcbiAgICAgICAgICAgICAgICAgIGlmIChzdWIgPT09IGlkKSB7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlID0gMDtcbiAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgYUluZGV4LnJlc3VsdHMucHVzaCh0aGlzLmVtb2ppc0xpc3RbaWRdKTtcbiAgICAgICAgICAgICAgICAgIGFJbmRleC5wb29sW2lkXSA9IGVtb2ppO1xuXG4gICAgICAgICAgICAgICAgICBzY29yZXNbaWRdID0gc2NvcmU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgYUluZGV4LnJlc3VsdHMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFTY29yZSA9IHNjb3Jlc1thLmlkXTtcbiAgICAgICAgICAgICAgICBjb25zdCBiU2NvcmUgPSBzY29yZXNbYi5pZF07XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYVNjb3JlIC0gYlNjb3JlO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYVBvb2wgPSBhSW5kZXgucG9vbDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gYUluZGV4LnJlc3VsdHM7XG4gICAgICAgIH0pXG4gICAgICAgIC5maWx0ZXIoYSA9PiBhKTtcblxuICAgICAgaWYgKGFsbFJlc3VsdHMubGVuZ3RoID4gMSkge1xuICAgICAgICByZXN1bHRzID0gaW50ZXJzZWN0LmFwcGx5KG51bGwsIGFsbFJlc3VsdHMgYXMgYW55KTtcbiAgICAgIH0gZWxzZSBpZiAoYWxsUmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgcmVzdWx0cyA9IGFsbFJlc3VsdHNbMF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRzID0gW107XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdHMpIHtcbiAgICAgIGlmIChlbW9qaXNUb1Nob3dGaWx0ZXIpIHtcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKChyZXN1bHQ6IEVtb2ppRGF0YSkgPT5cbiAgICAgICAgICBlbW9qaXNUb1Nob3dGaWx0ZXIodGhpcy5lbW9qaVNlcnZpY2UubmFtZXNbcmVzdWx0LmlkXSksXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXN1bHRzICYmIHJlc3VsdHMubGVuZ3RoID4gbWF4UmVzdWx0cykge1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5zbGljZSgwLCBtYXhSZXN1bHRzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdHMgfHwgbnVsbDtcbiAgfVxuXG4gIGJ1aWxkU2VhcmNoKFxuICAgIHNob3J0X25hbWVzOiBzdHJpbmdbXSxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAga2V5d29yZHM6IHN0cmluZ1tdLFxuICAgIGVtb3RpY29uczogc3RyaW5nW10sXG4gICkge1xuICAgIGNvbnN0IHNlYXJjaDogc3RyaW5nW10gPSBbXTtcblxuICAgIGNvbnN0IGFkZFRvU2VhcmNoID0gKHN0cmluZ3M6IHN0cmluZyB8IHN0cmluZ1tdLCBzcGxpdDogYm9vbGVhbikgPT4ge1xuICAgICAgaWYgKCFzdHJpbmdzKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgKEFycmF5LmlzQXJyYXkoc3RyaW5ncykgPyBzdHJpbmdzIDogW3N0cmluZ3NdKS5mb3JFYWNoKHN0cmluZyA9PiB7XG4gICAgICAgIChzcGxpdCA/IHN0cmluZy5zcGxpdCgvWy18X3xcXHNdKy8pIDogW3N0cmluZ10pLmZvckVhY2gocyA9PiB7XG4gICAgICAgICAgcyA9IHMudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgIGlmICghc2VhcmNoLmluY2x1ZGVzKHMpKSB7XG4gICAgICAgICAgICBzZWFyY2gucHVzaChzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfTtcblxuICAgIGFkZFRvU2VhcmNoKHNob3J0X25hbWVzLCB0cnVlKTtcbiAgICBhZGRUb1NlYXJjaChuYW1lLCB0cnVlKTtcbiAgICBhZGRUb1NlYXJjaChrZXl3b3JkcywgZmFsc2UpO1xuICAgIGFkZFRvU2VhcmNoKGVtb3RpY29ucywgZmFsc2UpO1xuXG4gICAgcmV0dXJuIHNlYXJjaC5qb2luKCcsJyk7XG4gIH1cbn1cbiJdfQ==